import { Component, OnInit, forwardRef, ElementRef, Self, Renderer, NgZone, ViewChild } from '@angular/core';
import {
    ControlValueAccessor, FormBuilder, FormGroup, DefaultValueAccessor, NgControl, NG_VALUE_ACCESSOR, FormControl
} from '@angular/forms';

import { LatLngLiteral, MouseEvent, MapsAPILoader } from '@agm/core';
//import { GoogleMap } from '@agm/core/services/google-maps-types';
import {  } from '@types/googlemaps';

@Component({
    selector: 'app-address-control',
    templateUrl: './address-control.component.html',
    styleUrls: ['./address-control.component.css'],
    providers: [
        {
            provide: NG_VALUE_ACCESSOR,
            useExisting: forwardRef(() => AddressControlComponent),
            multi: true
        }
    ]
})
export class AddressControlComponent implements OnInit, ControlValueAccessor {

    addressForm: FormGroup;
    lat: number;
    lng: number;
    address: string;
    officeLat: number;
    officeLng: number;
    //officeAddress: string = 'Заставская, 22';
    type: string;
    public searchControl: FormControl;
    public zoom: number;
    public map: google.maps.Map;//GoogleMap;

    @ViewChild('home')
    public homeElementRef: ElementRef;

    //@ViewChild('office')
    //public officeElementRef: ElementRef;

    propagateChange: (_: Address) => void;

    constructor(fb: FormBuilder, private mapsAPILoader: MapsAPILoader, private ngZone: NgZone) {
        this.setupForm(fb);
    }

    ngOnInit() {
        this.propagateChange = () => { };
        this.address = this.homeElementRef.nativeElement.value;
        //this.officeAddress = this.officeElementRef.nativeElement.value;

        // create search FormControl
        this.searchControl = new FormControl();

        // load Places Autocomplete
        this.mapsAPILoader.load().then(() => {
            let autocomplete = new google.maps.places.Autocomplete(this.homeElementRef.nativeElement, {
                types: ['address']
            });

            autocomplete.addListener('place_changed', () => {
                this.ngZone.run(() => {
                // get the place result
                let place: google.maps.places.PlaceResult = autocomplete.getPlace();

                // verify result
                if (place.geometry === undefined || place.geometry === null) {
                   return;
                }

                // save and show
                this.updateLocation({lng: place.geometry.location.lng(), lat: place.geometry.location.lat()});
                });
            });

            this.getLocationByAddress('Заставская, 22').then(
            result => {
                this.officeLat = (<any>result).lat;
                this.officeLng = (<any>result).lng;
            },
            error => {}
        );
        });
    }

    setupForm(fb: FormBuilder) {
        this.addressForm = fb.group({
            id: '',
            address: '',
            latitude: '',
            longitude: '',
            type: ''
        });
        this.addressForm.valueChanges.subscribe(() => {
            this.propagateChange(this.addressForm.value);
        });
        this.addressForm.get('latitude').valueChanges.subscribe(newLat => {
            if (newLat) {
                this.setCoords(this.lng, newLat);
            }
        });
        this.addressForm.get('longitude').valueChanges.subscribe(newLng => {
            if (newLng) {
                this.setCoords(newLng, this.lat);
            }
        });
    }

    mapReady(map: google.maps.Map) {
        console.log(map);
        const coords: LatLngLiteral = { lat: +this.lat, lng: +this.lng };
        this.setCoords(this.lng, this.lat);
        map.setCenter(coords);
        // map.data;
        this.map = map;

        this.drawRoute('Воронежская, 5', 'Заставская, 22');
    }

    mapClick($event: MouseEvent) {
        this.setCoords($event.coords.lng, $event.coords.lat);
        this.addressForm.get('latitude').setValue(this.lat);
        this.addressForm.get('longitude').setValue(this.lng);
        this.propagateChange(this.addressForm.value);
    }

    setCoords(lng, lat) {
        console.log('changing coords from: ', this.lng, this.lat);
        this.lng = +lng;
        this.lat = +lat;
        console.log('new coords: ', this.lng, this.lat);
    }

    updateFormCoords() {
        this.addressForm.get('latitude').setValue(this.lat);
        this.addressForm.get('longitude').setValue(this.lng);
    }

    setZoom(zoom) {
        if (!!zoom) {
            this.zoom = zoom;
        }
    }

    writeValue(obj: Address): void {
        if (obj) {
            this.addressForm.patchValue(obj);
        }
    }

    registerOnChange(fn: any): void {
        this.propagateChange = fn;
    }

    registerOnTouched(fn: any): void {
        // do nothing?
    }

    setDisabledState(isDisabled: boolean): void {
        throw new Error('Method not implemented.');
    }

    setCenter() {
        if (!this.map) {
            return;
        }

        const coords: LatLngLiteral = { lat: +this.lat, lng: +this.lng };
        this.map.setCenter(coords);
    }

    onChange(event) {
        this.getLocationByAddress(this.address).then(
            result => this.updateLocation(result),
            error => {console.log('geocoding failed');}
        );
    }

    updateLocation(location: any) {
        const coords: LatLngLiteral = <any>location;
        this.map.setCenter(coords);
        this.setCoords(coords.lng, coords.lat);
        this.updateFormCoords();
        this.setZoom(12);
        this.setCenter();
    }

    getLocationByAddress(address: string): Promise<string> {
        return new Promise((resolve, reject) => {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode( { 'address': address }, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    const location = results[0].geometry.location;
                    resolve({ lat: +location.lat(), lng: +location.lng() });
                } else {
                    reject();
                }
            });
        });
    }

    drawRoute(origin: string, target: string) {
        if (!this.map) { 
            return;
        }

        let directionsService = new google.maps.DirectionsService;
        let directionsDisplay = new google.maps.DirectionsRenderer(
            {suppressMarkers: true}
        );

        directionsDisplay.setMap(this.map);
        this.calculateAndDisplayRoute(directionsService, directionsDisplay);
    }

    calculateAndDisplayRoute(directionsService, directionsDisplay) {
        var waypts = [];
        var checkboxArray:any[] = [
            'Транспортный, 10'
       ];
       for (var i = 0; i < checkboxArray.length; i++) {

            waypts.push({
              location: checkboxArray[i],
              stopover: true
            });

        }
        //const corigin: google.maps.LatLng = new google.maps.LatLng(this.lat, this.lng);
        //const dest: google.maps.LatLng = new google.maps.LatLng(this.officeLat, this.officeLng );

        directionsService.route({
           origin: 'Voronezhskaya, 5',
           destination: 'Заставская, 22',
           waypoints: waypts,
           optimizeWaypoints: true,
           travelMode: 'DRIVING'
        }, function(response, status) {
           if (status === 'OK') {
              console.log("route status OK", response);
              //directionsDisplay.map.fitBounds(response.routes.bounds);
              directionsDisplay.setDirections(response);
              //this.createPolyline(response);
           } else {
             window.alert('Directions request failed due to ' + status);
           }
        });
    }
}

export interface Address {
    id: string;
    latitude: number;
    longitude: number;
    address: string;
    type: string;
    officeLat: number;
    officeLng: number;
}


<agm-map (mapClick)="mapClick($event)" [usePanning]="true" (mapReady)="mapReady($event)" [zoom]="15">
    <agm-marker [latitude]="lat" [longitude]="lng" [iconUrl]="'\/img\/bighouse.png'"></agm-marker>
    <agm-marker [latitude]="officeLat" [longitude]="officeLng" [iconUrl]="'\/img\/apartment-3.png'"></agm-marker>
</agm-map>

<div [formGroup]="addressForm">
    <div class="formRow">
        <md-input-container>
            <input mdInput placeholder="Address" [formControl]="addressForm.get('address')" #home autocorrect="off" autocapitalize="off" spellcheck="off"
            (change)="onChange($event)" (keyup)="onChange($event)">
        </md-input-container>
    </div>
    <div class="formRow">
        <md-input-container>
            <input mdInput placeholder="Latitude" [formControl]="addressForm.get('latitude')">
        </md-input-container>
        <md-input-container>
            <input mdInput placeholder="Longitude" [formControl]="addressForm.get('longitude')">
        </md-input-container>
    </div>
</div>

